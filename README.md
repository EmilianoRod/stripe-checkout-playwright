# Stripe Checkout E2E Automation (Playwright + Java Bridge)

End-to-end automation for **Stripe Hosted Checkout**, including optional **3-D Secure (3DS)** challenges.  
Written in **Playwright (Node.js)** with a **Java bridge** to run the Playwright test from Selenium/JUnit/TestNG and return the final success URL so you can continue assertions in the same Selenium session.

---

## âœ¨ Features
- Fills Stripe Checkout (split or unified Payment Element iframes)
- Handles optional 3â€‘D Secure (3DS) challenge **safely** (only if it appears)
- Prints a machineâ€‘readable marker with the final URL: `PW_BRIDGE::SUCCESS_URL ...`
- Java bridge (`PlaywrightStripeBridge`) launches the Playwright test and **returns** the success URL to your Selenium test
- Works in **headed** or headless mode

---

## ğŸ“‚ Project Structure
```
.
â”œâ”€ tests/
â”‚  â””â”€ stripe-checkout.spec.ts
â”œâ”€ pages/
â”‚  â””â”€ Shop/Stripe/PlaywrightStripeBridge.java
â”œâ”€ package.json
â”œâ”€ playwright.config.ts
â””â”€ README.md
```

---

## ğŸ”§ Prerequisites
- Node.js 18+  
- Java 11+ (for the bridge)  
- Stripe test account (for test cards)  

---

## â–¶ï¸ Install & Run (Playwright only)

```bash
# 1) Install deps
npm install

# 2) (First time) install browsers
npx playwright install

# 3) Run the test (headed is useful while developing)
CHECKOUT_URL="https://checkout.stripe.com/c/pay/..." \
CHECKOUT_EMAIL="qa+stripe@example.com" \
npx playwright test tests/stripe-checkout.spec.ts --headed
```

**Environment variables**
- `CHECKOUT_URL` â€“ Fresh Stripe Checkout URL to pay (generated by your app/server)
- `CHECKOUT_EMAIL` â€“ Email to enter on the Stripe page (defaults to `qa+stripe@example.com`)

> The spec prints `PW_BRIDGE::SUCCESS_URL <final-url>` at the end.

---

## ğŸ’³ Forcing 3â€‘D Secure (3DS)
Stripe test cards:
- **Always requires 3DS**: `4000 0027 6000 3184`
- **No 3DS (happy path)**: `4242 4242 4242 4242` (default in the spec)

Switch the `CARD` constant in the spec to exercise either path.

---

## â˜• Java Bridge Usage (Selenium/JUnit/TestNG)

Use the bridge to run Playwright and resume in the **same Selenium window**:

```java
// Get a fresh checkout URL from your app under test
String freshCheckoutUrl = preview.proceedToStripeAndGetCheckoutUrl();

// Run Playwright and retrieve the post-payment URL
PlaywrightStripeBridge.Result result = PlaywrightStripeBridge.payReturning(
    PlaywrightStripeBridge.Options.defaultOptions()
        .setCheckoutUrl(freshCheckoutUrl)
        .setCheckoutEmail("qa+stripe@example.com")
        .setHeaded(true)             // visible Playwright browser is OK
        .setProject("chromium")      // must match your playwright.config
        .setWorkingDirectory(new File(".")) // repo root with Playwright files
);

if (!result.isSuccess()) {
    throw new AssertionError("Stripe payment failed via Playwright.");
}

// Continue Selenium assertions in the original browser
String successUrl = result.getSuccessUrl();
if (successUrl != null) {
    driver.navigate().to(successUrl);
} else {
    // Fallback, e.g. navigate back to dashboard
    driver.navigate().to("https://yourapp.example.com/dashboard");
}
```

> The Playwright spec must include the line:
> ```ts
> console.log(`PW_BRIDGE::SUCCESS_URL ${page.url()}`);
> ```

---

## ğŸ­ Playwright Test Highlights

- Always fills **Email**
- Supports **split** and **unified** card iframes
- Gated 3DS handler (enters challenge iframe only if present)
- Ends with a small race to detect success/receipt URL

Key snippet (already included in the spec):

```ts
// After payment + 3DS (if any)
await Promise.race([
  page.waitForURL(/(success|thank|return|receipt)/i, { timeout: 15000 }).catch(() => {}),
  page.waitForLoadState('networkidle', { timeout: 15000 }).catch(() => {}),
]);

console.log(`PW_BRIDGE::SUCCESS_URL ${page.url()}`);
```

---

## âš™ï¸ GitHub Actions (CI)

Minimal workflow to run the test on every push (Node 20 + Ubuntu).  
Create `.github/workflows/playwright.yml`:

```yaml
name: Playwright

on:
  push:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install browsers
        run: npx playwright install --with-deps

      - name: Run Stripe checkout test
        env:
          CHECKOUT_URL: ${{ secrets.CHECKOUT_URL }}
          CHECKOUT_EMAIL: qa+stripe@example.com
        run: npx playwright test tests/stripe-checkout.spec.ts
```

> In your repo settings, add **Actions Secret** `CHECKOUT_URL` pointing to a valid, fresh test Checkout URL (or wire a step to generate one via your backend).

---

## ğŸ“ .gitignore

```
node_modules/
test-results/
playwright-report/
playwright/.cache/
.DS_Store
```

---

## ğŸ” Tips & Troubleshooting

- **The test didnâ€™t capture `SUCCESS_URL`:**  
  Ensure the Playwright spec prints the marker exactly:  
  `console.log('PW_BRIDGE::SUCCESS_URL ' + page.url())`

- **3DS frame errors:**  
  Use the 3DS card (`4000 0027 6000 3184`). The handler waits up to ~10s and clicks common approval buttons. Increase timeout if your issuer is slow.

- **Local Playwright binary not found in CI:**  
  The bridge falls back to `npx playwright test` if `node_modules/.bin/playwright` isnâ€™t present on Unix.

- **Headed vs headless:**  
  Set with `.setHeaded(true/false)` on `Options`. Headed is fine; CI often runs headless.

---

## ğŸ“œ License
MIT (or choose your preferred license).
